openapi: 3.0.3
info:
  title: Griot-Hub Authentication & Admin API
  description: |
    API specification for authentication, user management, team management,
    and role/permission management in Griot-Hub.

    ## Authentication
    All protected endpoints require a Bearer token in the Authorization header.
    Tokens are obtained via the login or OAuth endpoints.

    ## Roles
    - **admin**: Full system access, can manage users, teams, and roles
    - **editor**: Can create and edit contracts and assets, cannot manage users
    - **viewer**: Read-only access to contracts, assets, and reports

    ## Hardcoded Admin (Development)
    - Email: `brackly@griot.com`
    - Password: `melly`

    ## Implementation Status (Mock APIs)
    The following endpoints are fully implemented as Next.js API routes with in-memory mock data:

    **Authentication** (All implemented)
    - POST /auth/login ✓
    - POST /auth/signup ✓
    - POST /auth/logout ✓
    - GET /auth/me ✓

    **Users** (Implemented)
    - GET /users ✓
    - POST /users ✓
    - PATCH /users/{userId} ✓
    - DELETE /users/{userId} ✓

    **Teams** (Fully implemented)
    - GET /teams ✓
    - POST /teams ✓
    - GET /teams/{teamId} ✓
    - PATCH /teams/{teamId} ✓
    - DELETE /teams/{teamId} ✓
    - GET /teams/{teamId}/members ✓
    - POST /teams/{teamId}/members ✓
    - PATCH /teams/{teamId}/members/{memberId} ✓
    - DELETE /teams/{teamId}/members/{memberId} ✓

    **Roles** (Fully implemented)
    - GET /roles ✓
    - POST /roles ✓
    - GET /roles/{roleId} ✓
    - PATCH /roles/{roleId} ✓
    - DELETE /roles/{roleId} ✓
    - GET /permissions ✓

    **OAuth** (Stub only - returns 501)
    - POST /auth/oauth/google
    - POST /auth/oauth/microsoft
    - POST /auth/oauth/sso
  version: 1.0.0
  contact:
    name: Griot Team

servers:
  - url: /api
    description: Local development server

tags:
  - name: Authentication
    description: Login, signup, logout, password reset
  - name: OAuth
    description: OAuth provider authentication
  - name: Users
    description: User management (admin only)
  - name: Teams
    description: Team management
  - name: Roles
    description: Role and permission management

paths:
  # ============================================
  # AUTHENTICATION
  # ============================================
  /auth/login:
    post:
      tags: [Authentication]
      summary: Login with email and password
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /auth/signup:
    post:
      tags: [Authentication]
      summary: Register a new user
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /auth/logout:
    post:
      tags: [Authentication]
      summary: Logout current user
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully

  /auth/me:
    get:
      tags: [Authentication]
      summary: Get current authenticated user
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/forgot-password:
    post:
      tags: [Authentication]
      summary: Request password reset email
      operationId: forgotPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
      responses:
        '200':
          description: Reset email sent (always returns success for security)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: If the email exists, a reset link has been sent

  /auth/reset-password:
    post:
      tags: [Authentication]
      summary: Reset password with token
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, password, confirmPassword]
              properties:
                token:
                  type: string
                  description: Reset token from email
                password:
                  type: string
                  format: password
                  minLength: 8
                confirmPassword:
                  type: string
                  format: password
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password has been reset successfully
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # OAUTH
  # ============================================
  /auth/oauth/google:
    post:
      tags: [OAuth]
      summary: Authenticate with Google OAuth
      operationId: googleOAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code:
                  type: string
                  description: OAuth authorization code from Google
                redirectUri:
                  type: string
                  description: Redirect URI used in OAuth flow
      responses:
        '200':
          description: OAuth successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: OAuth failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/oauth/microsoft:
    post:
      tags: [OAuth]
      summary: Authenticate with Microsoft OAuth
      operationId: microsoftOAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code:
                  type: string
                  description: OAuth authorization code from Microsoft
                redirectUri:
                  type: string
                  description: Redirect URI used in OAuth flow
      responses:
        '200':
          description: OAuth successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: OAuth failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/oauth/sso:
    post:
      tags: [OAuth]
      summary: Authenticate with Enterprise SSO (SAML/OIDC)
      operationId: enterpriseSSO
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
                  description: SSO token or assertion
                provider:
                  type: string
                  description: SSO provider identifier
      responses:
        '200':
          description: SSO successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: SSO failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # USERS
  # ============================================
  /users:
    get:
      tags: [Users]
      summary: List all users
      operationId: listUsers
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: search
          in: query
          schema:
            type: string
          description: Search by name or email
        - name: role
          in: query
          schema:
            type: string
            enum: [admin, editor, viewer]
        - name: teamId
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [active, pending, deactivated]
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/invite:
    post:
      tags: [Users]
      summary: Invite a new user
      operationId: inviteUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InviteUserRequest'
      responses:
        '201':
          description: Invitation sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: User already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{userId}:
    get:
      tags: [Users]
      summary: Get user by ID
      operationId: getUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags: [Users]
      summary: Update user
      operationId: updateUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '403':
          description: Not authorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Users]
      summary: Deactivate user
      operationId: deactivateUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User deactivated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User deactivated successfully
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{userId}/role:
    patch:
      tags: [Users]
      summary: Change user role
      operationId: changeUserRole
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [roleId]
              properties:
                roleId:
                  type: string
                  description: ID of the role to assign
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # TEAMS
  # ============================================
  /teams:
    get:
      tags: [Teams]
      summary: List all teams
      operationId: listTeams
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of teams
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamListResponse'

    post:
      tags: [Teams]
      summary: Create a new team
      operationId: createTeam
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTeamRequest'
      responses:
        '201':
          description: Team created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Team'
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /teams/{teamId}:
    get:
      tags: [Teams]
      summary: Get team details
      operationId: getTeam
      security:
        - bearerAuth: []
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Team details with members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamDetail'
        '404':
          description: Team not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags: [Teams]
      summary: Update team
      operationId: updateTeam
      security:
        - bearerAuth: []
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTeamRequest'
      responses:
        '200':
          description: Team updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Team'
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Teams]
      summary: Delete team
      operationId: deleteTeam
      security:
        - bearerAuth: []
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Team deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Team deleted successfully
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /teams/{teamId}/members:
    post:
      tags: [Teams]
      summary: Add member to team
      operationId: addTeamMember
      security:
        - bearerAuth: []
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userId]
              properties:
                userId:
                  type: string
                roleId:
                  type: string
                  description: Optional override role for this member
      responses:
        '200':
          description: Member added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamDetail'
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /teams/{teamId}/members/{memberId}:
    patch:
      tags: [Teams]
      summary: Update member role in team
      operationId: updateTeamMemberRole
      security:
        - bearerAuth: []
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
        - name: memberId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role:
                  type: string
                  description: New role name for the member
      responses:
        '200':
          description: Member role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamMember'
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Team or member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Teams]
      summary: Remove member from team
      operationId: removeTeamMember
      security:
        - bearerAuth: []
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
        - name: memberId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Member removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Member removed from team
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # ROLES & PERMISSIONS
  # ============================================
  /roles:
    get:
      tags: [Roles]
      summary: List all roles
      operationId: listRoles
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of roles
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'

    post:
      tags: [Roles]
      summary: Create a new role
      operationId: createRole
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
      responses:
        '201':
          description: Role created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /roles/{roleId}:
    get:
      tags: [Roles]
      summary: Get role details
      operationId: getRole
      security:
        - bearerAuth: []
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Role details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '404':
          description: Role not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags: [Roles]
      summary: Update role
      operationId: updateRole
      security:
        - bearerAuth: []
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRoleRequest'
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Roles]
      summary: Delete role
      operationId: deleteRole
      security:
        - bearerAuth: []
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Role deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Role deleted successfully
        '403':
          description: Not authorized (admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Cannot delete role that is in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /permissions:
    get:
      tags: [Roles]
      summary: List all available permissions
      operationId: listPermissions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of all permissions
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Permission'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ============================================
    # REQUEST SCHEMAS
    # ============================================
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          example: brackly@griot.com
        password:
          type: string
          format: password
          example: melly
        rememberMe:
          type: boolean
          default: false

    SignupRequest:
      type: object
      required: [name, email, password, confirmPassword]
      properties:
        name:
          type: string
          minLength: 2
          example: John Doe
        email:
          type: string
          format: email
          example: john@example.com
        password:
          type: string
          format: password
          minLength: 8
        confirmPassword:
          type: string
          format: password
        acceptTerms:
          type: boolean
          default: false

    InviteUserRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email
        roleId:
          type: string
          description: Role to assign (defaults to viewer)
        teamId:
          type: string
          description: Team to add user to

    UpdateUserRequest:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        avatar:
          type: string
          format: uri

    CreateTeamRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 2
          example: Data Engineering
        description:
          type: string
        defaultRoleId:
          type: string
          description: Default role for team members
        domains:
          type: array
          items:
            type: string
          example: [analytics, finance]

    UpdateTeamRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        defaultRoleId:
          type: string
        domains:
          type: array
          items:
            type: string

    CreateRoleRequest:
      type: object
      required: [name, permissions]
      properties:
        name:
          type: string
          minLength: 2
          example: Data Analyst
        description:
          type: string
        permissions:
          type: array
          items:
            type: string
          example: [contracts:read, assets:read, reports:view]

    UpdateRoleRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        permissions:
          type: array
          items:
            type: string

    # ============================================
    # RESPONSE SCHEMAS
    # ============================================
    AuthResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
          description: JWT access token
        expiresAt:
          type: string
          format: date-time

    User:
      type: object
      properties:
        id:
          type: string
          example: user-001
        name:
          type: string
          example: Brackly Murunga
        email:
          type: string
          format: email
          example: brackly@griot.com
        avatar:
          type: string
          format: uri
          nullable: true
        role:
          $ref: '#/components/schemas/Role'
        team:
          $ref: '#/components/schemas/TeamSummary'
        status:
          type: string
          enum: [active, pending, deactivated]
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    UserListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/User'
        pagination:
          $ref: '#/components/schemas/Pagination'

    Team:
      type: object
      properties:
        id:
          type: string
          example: team-001
        name:
          type: string
          example: Data Engineering
        description:
          type: string
          nullable: true
        memberCount:
          type: integer
        defaultRole:
          $ref: '#/components/schemas/RoleSummary'
        domains:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time

    TeamSummary:
      type: object
      properties:
        id:
          type: string
        name:
          type: string

    TeamDetail:
      allOf:
        - $ref: '#/components/schemas/Team'
        - type: object
          properties:
            members:
              type: array
              items:
                $ref: '#/components/schemas/TeamMember'

    TeamMember:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        role:
          $ref: '#/components/schemas/RoleSummary'
        isRoleInherited:
          type: boolean
          description: True if role is from team default, false if explicitly set
        joinedAt:
          type: string
          format: date-time

    TeamListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Team'
        pagination:
          $ref: '#/components/schemas/Pagination'

    Role:
      type: object
      properties:
        id:
          type: string
          example: role-admin
        name:
          type: string
          example: Admin
        description:
          type: string
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/Permission'
        isSystem:
          type: boolean
          description: True for built-in roles (admin, editor, viewer)
        userCount:
          type: integer
          description: Number of users with this role
        createdAt:
          type: string
          format: date-time

    RoleSummary:
      type: object
      properties:
        id:
          type: string
        name:
          type: string

    Permission:
      type: object
      properties:
        id:
          type: string
          example: contracts:read
        name:
          type: string
          example: View Contracts
        category:
          type: string
          enum: [contracts, assets, issues, admin, reports]
        description:
          type: string

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    # ============================================
    # ERROR SCHEMAS
    # ============================================
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: UNAUTHORIZED
            message:
              type: string
              example: Invalid credentials

    ValidationErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: VALIDATION_ERROR
            message:
              type: string
              example: Validation failed
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string
