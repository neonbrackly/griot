# =============================================================================
# GRIOT REGISTRY API SPECIFICATION
# =============================================================================
# Owner: registry agent
# Consumers: hub, cli (for push/pull)
#
# OpenAPI 3.0 specification for griot-registry REST API
# Updated: 2026-01-22 - All endpoints tested and verified
# =============================================================================

openapi: "3.0.3"
info:
  title: Griot Registry API
  description: |
    Central registry for Griot data contracts. Provides storage, versioning,
    validation, approval workflows, and collaboration features for ODCS-compliant
    data contracts.

    ## Authentication

    Most write operations require JWT authentication.

    **Login (recommended):**
    ```
    POST /api/v1/auth/login
    { "email": "user@example.com", "password": "SecurePass123" }
    ```

    **Signup:**
    ```
    POST /api/v1/auth/signup
    { "name": "John", "email": "...", "password": "...", "confirmPassword": "...", "acceptTerms": true }
    ```

    **Legacy token (dev/testing):**
    ```
    POST /api/v1/auth/token?user_id=myuser&roles=editor
    ```

    Include the token in requests:
    ```
    Authorization: Bearer <token>
    ```

    ## Contract Format (ODCS)

    Contracts use the Open Data Contract Standard (ODCS) format:
    ```json
    {
      "apiVersion": "v1.0.0",
      "kind": "DataContract",
      "id": "unique-id",
      "name": "contract_name",
      "version": "1.0.0",
      "status": "draft",
      "schema": [...]
    }
    ```
  version: "0.2.0"
  contact:
    name: Griot Team
  license:
    name: Apache 2.0

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: health
    description: Service health checks
  - name: auth
    description: Authentication and authorization
  - name: contracts
    description: Contract CRUD operations
  - name: versions
    description: Contract versioning
  - name: schemas
    description: Schema catalog queries (legacy)
  - name: standalone-schemas
    description: |
      Standalone schema management - CRUD, lifecycle, versioning.
      Schemas are first-class entities that can be created independently
      and reused across multiple contracts via schemaRefs.
  - name: validations
    description: Validation records
  - name: runs
    description: Pipeline run tracking
  - name: issues
    description: Issue management
  - name: comments
    description: Collaboration comments
  - name: approvals
    description: Approval workflows
  - name: search
    description: Search contracts

# =============================================================================
# PATHS
# =============================================================================
paths:
  # ---------------------------------------------------------------------------
  # Health
  # ---------------------------------------------------------------------------
  /health:
    get:
      tags: [health]
      summary: Health check
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: Service health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/live:
    get:
      tags: [health]
      summary: Liveness probe
      operationId: livenessCheck
      security: []
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "alive"

  /health/ready:
    get:
      tags: [health]
      summary: Readiness probe
      operationId: readinessCheck
      security: []
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ready, not ready]

  # ---------------------------------------------------------------------------
  # Authentication
  # ---------------------------------------------------------------------------
  /auth/login:
    post:
      tags: [auth]
      summary: User login
      description: |
        Authenticate user with email and password.

        **Features:**
        - Returns JWT token and user data on success
        - Account locked after 5 failed attempts for 15 minutes
        - "Remember me" extends token to 30 days (default 24 hours)
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'
        '423':
          description: Account locked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'

  /auth/signup:
    post:
      tags: [auth]
      summary: User registration
      description: |
        Register a new user account.

        **Password requirements:**
        - Minimum 8 characters
        - At least 1 uppercase letter
        - At least 1 lowercase letter
        - At least 1 number

        New users receive the default "Viewer" role.
      operationId: signup
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: Account created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'

  /auth/logout:
    post:
      tags: [auth]
      summary: User logout
      description: |
        Logout the current user and invalidate the session.

        Note: For stateless JWT, the client should discard the token.
        Token blacklisting is not implemented in this version.
      operationId: logout
      responses:
        '204':
          description: Logout successful
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/me:
    get:
      tags: [auth]
      summary: Get current user profile
      description: |
        Get the current authenticated user's profile.
        Returns complete user information including role and team.
      operationId: getCurrentUser
      responses:
        '200':
          description: Current user information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUserResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: User not found

  /auth/forgot-password:
    post:
      tags: [auth]
      summary: Request password reset
      description: |
        Request a password reset link.

        If the email exists, a reset token is generated.
        For security, always returns success even if email doesn't exist.
      operationId: forgotPassword
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '200':
          description: Reset email sent (if account exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "If an account exists with that email, a password reset link has been sent."

  /auth/reset-password:
    post:
      tags: [auth]
      summary: Reset password with token
      description: |
        Reset password using a valid reset token.

        Token must not be expired (1 hour validity) and must not have been used before.
      operationId: resetPassword
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Password has been reset successfully."
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'

  /auth/refresh:
    post:
      tags: [auth]
      summary: Refresh access token
      description: Refresh an access token using a refresh token.
      operationId: refreshToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
                  description: The refresh token
      responses:
        '200':
          description: Token refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid or expired refresh token

  /auth/token:
    post:
      tags: [auth]
      summary: Create access token (legacy/dev)
      description: |
        Legacy endpoint for creating access tokens directly.
        Primarily used for development and testing.
      operationId: createToken
      security: []
      parameters:
        - name: user_id
          in: query
          required: true
          schema:
            type: string
          description: User identifier
        - name: email
          in: query
          schema:
            type: string
          description: User email
        - name: name
          in: query
          schema:
            type: string
          description: User name
        - name: roles
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [viewer, editor, admin]
          style: form
          explode: true
          description: User roles
      responses:
        '200':
          description: Token generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Invalid role specified

  /auth/oauth/google:
    post:
      tags: [auth]
      summary: Google OAuth callback
      description: Google OAuth authentication (not yet implemented).
      operationId: oauthGoogle
      security: []
      responses:
        '501':
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'

  /auth/oauth/microsoft:
    post:
      tags: [auth]
      summary: Microsoft OAuth callback
      description: Microsoft OAuth authentication (not yet implemented).
      operationId: oauthMicrosoft
      security: []
      responses:
        '501':
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'

  /auth/oauth/sso:
    post:
      tags: [auth]
      summary: Enterprise SSO callback
      description: Enterprise SSO authentication (not yet implemented).
      operationId: oauthSSO
      security: []
      responses:
        '501':
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthErrorResponse'

  # ---------------------------------------------------------------------------
  # Contracts
  # ---------------------------------------------------------------------------
  /contracts:
    get:
      tags: [contracts]
      summary: List all contracts
      operationId: listContracts
      security: []
      parameters:
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, active, deprecated, retired]
        - name: schema_name
          in: query
          schema:
            type: string
        - name: owner
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of contracts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContractListResponse'

    post:
      tags: [contracts]
      summary: Create new contract
      operationId: createContract
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ODCSContract'
      responses:
        '201':
          description: Contract created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Contract already exists
        '422':
          $ref: '#/components/responses/ValidationFailed'

  /contracts/validate:
    post:
      tags: [contracts]
      summary: Validate contract without storing
      operationId: validateContract
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ODCSContract'
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContractValidationResponse'

  /contracts/{contractId}:
    get:
      tags: [contracts]
      summary: Get contract by ID
      operationId: getContract
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: version
          in: query
          schema:
            type: string
          description: Specific version to retrieve
      responses:
        '200':
          description: Contract details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [contracts]
      summary: Update contract (creates new version)
      operationId: updateContract
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: allow_breaking
          in: query
          schema:
            type: boolean
            default: false
          description: Allow breaking changes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContractUpdateRequest'
      responses:
        '200':
          description: Contract updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '409':
          description: Breaking changes detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BreakingChangesResponse'

    delete:
      tags: [contracts]
      summary: Deprecate contract
      operationId: deprecateContract
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
      responses:
        '204':
          description: Contract deprecated
        '404':
          $ref: '#/components/responses/NotFound'

  /contracts/{contractId}/status:
    patch:
      tags: [contracts]
      summary: Update contract status
      operationId: updateContractStatus
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StatusUpdateRequest'
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '400':
          description: Invalid status transition

  # ---------------------------------------------------------------------------
  # Versions
  # ---------------------------------------------------------------------------
  /contracts/{contractId}/versions:
    get:
      tags: [versions]
      summary: List contract versions
      operationId: listVersions
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Version list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionListResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /contracts/{contractId}/versions/{version}:
    get:
      tags: [versions]
      summary: Get specific version
      operationId: getVersion
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: version
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Contract at version
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '404':
          $ref: '#/components/responses/NotFound'

  # ---------------------------------------------------------------------------
  # Schemas
  # ---------------------------------------------------------------------------
  /schemas:
    get:
      tags: [schemas]
      summary: Find schemas across contracts
      operationId: findSchemas
      security: []
      parameters:
        - name: name
          in: query
          schema:
            type: string
          description: Filter by schema name
        - name: physical_name
          in: query
          schema:
            type: string
          description: Filter by physical table name
        - name: field_name
          in: query
          schema:
            type: string
          description: Filter by field name
        - name: has_pii
          in: query
          schema:
            type: boolean
          description: Filter by PII flag
        - $ref: '#/components/parameters/limitParam'
      responses:
        '200':
          description: Schema catalog entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaCatalogResponse'

  /schemas/contracts/{schemaName}:
    get:
      tags: [schemas]
      summary: Get contracts containing a schema
      operationId: getContractsBySchema
      security: []
      parameters:
        - name: schemaName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Contract IDs
          content:
            application/json:
              schema:
                type: object
                properties:
                  schema_name:
                    type: string
                  contract_ids:
                    type: array
                    items:
                      type: string
                  count:
                    type: integer

  /schemas/rebuild:
    post:
      tags: [schemas]
      summary: Rebuild schema catalog
      operationId: rebuildSchemaCatalog
      responses:
        '200':
          description: Catalog rebuilt
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  schemas_indexed:
                    type: integer

  # ---------------------------------------------------------------------------
  # Standalone Schemas - CRUD, Lifecycle, Versioning
  # ---------------------------------------------------------------------------
  /schemas:
    post:
      tags: [standalone-schemas]
      summary: Create a new standalone schema
      description: |
        Create a new standalone schema definition that can be reused across contracts.

        **Behavior:**
        - Creates schema in `draft` status (not yet usable in contracts)
        - Auto-generates unique ID (`sch-xxxxxxxxxxxx`)
        - Sets initial version to `1.0.0`
        - Records creator and timestamp for audit trail
        - Analyzes properties to detect PII fields

        **When to use:**
        - Defining a new data asset (table, topic, file structure)
        - From "Data Assets" page when clicking "New Schema"
      operationId: createStandaloneSchema
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StandaloneSchemaCreateRequest'
      responses:
        '201':
          description: Schema created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandaloneSchema'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Schema with this name already exists

    get:
      tags: [standalone-schemas]
      summary: List standalone schemas
      description: |
        Retrieve a paginated list of standalone schemas with filtering.

        **When to use:**
        - Populating schema picker in contract wizard (use `activeOnly=true`)
        - Displaying all schemas in Data Assets page
        - Searching for schemas by domain or owner
      operationId: listStandaloneSchemas
      security: []
      parameters:
        - name: search
          in: query
          description: Full-text search on name, description, physical_name
          schema:
            type: string
        - name: domain
          in: query
          description: Filter by business domain
          schema:
            type: string
        - name: status
          in: query
          description: Filter by lifecycle status
          schema:
            type: string
            enum: [draft, active, deprecated]
        - name: activeOnly
          in: query
          description: Shorthand for status=active (for contract wizard)
          schema:
            type: boolean
            default: false
        - name: source
          in: query
          description: Filter by origin
          schema:
            type: string
            enum: [manual, connection, import]
        - name: ownerId
          in: query
          description: Filter by owner user ID
          schema:
            type: string
        - name: ownerTeamId
          in: query
          description: Filter by owner team ID
          schema:
            type: string
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: List of schemas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandaloneSchemaListResponse'

  /schemas/{schemaId}:
    get:
      tags: [standalone-schemas]
      summary: Get standalone schema by ID
      description: |
        Retrieve full details of a specific standalone schema.

        **Query Parameters:**
        - `version` - Get a specific historical version (default: current)
      operationId: getStandaloneSchema
      security: []
      parameters:
        - $ref: '#/components/parameters/schemaIdParam'
        - name: version
          in: query
          description: Specific version to retrieve
          schema:
            type: string
      responses:
        '200':
          description: Schema details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandaloneSchema'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [standalone-schemas]
      summary: Update standalone schema
      description: |
        Modify an existing schema's properties, description, or structure.

        **Behavior:**
        - Only allowed on `draft` schemas by default
        - For `active` schemas, detects breaking changes:
          - Removed properties
          - Type changes
          - Required field additions
        - If breaking changes detected, returns 400 with details
        - Admin can use `forceBreaking=true` to override
      operationId: updateStandaloneSchema
      parameters:
        - $ref: '#/components/parameters/schemaIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StandaloneSchemaUpdateRequest'
      responses:
        '200':
          description: Schema updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandaloneSchema'
        '400':
          description: Breaking changes detected or invalid data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaBreakingChangesError'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [standalone-schemas]
      summary: Delete standalone schema
      description: |
        Permanently remove a schema from the system.

        **Behavior:**
        - Fails if schema is referenced by any contracts
        - Returns 409 Conflict with list of dependent contracts
        - Deletes all version history when successful
      operationId: deleteStandaloneSchema
      parameters:
        - $ref: '#/components/parameters/schemaIdParam'
      responses:
        '204':
          description: Schema deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Schema is in use by contracts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaInUseError'

  /schemas/{schemaId}/publish:
    post:
      tags: [standalone-schemas]
      summary: Publish schema (draft → active)
      description: |
        Transition a draft schema to active status, making it available for contracts.

        **Behavior:**
        - Only works on schemas in `draft` status
        - Changes status to `active`
        - Records publish timestamp and user
        - Schema now appears in contract wizard schema picker
      operationId: publishSchema
      parameters:
        - $ref: '#/components/parameters/schemaIdParam'
      responses:
        '200':
          description: Schema published
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandaloneSchema'
        '400':
          description: Schema is not in draft status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  /schemas/{schemaId}/deprecate:
    post:
      tags: [standalone-schemas]
      summary: Deprecate schema (active → deprecated)
      description: |
        Mark a schema as deprecated, signaling it should not be used for new contracts.

        **Behavior:**
        - Only works on `active` schemas
        - Does NOT break existing contracts using this schema
        - Notifies contracts that depend on this schema
        - Schema still works but shows deprecation warning
      operationId: deprecateSchema
      parameters:
        - $ref: '#/components/parameters/schemaIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SchemaDeprecateRequest'
      responses:
        '200':
          description: Schema deprecated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandaloneSchema'
        '400':
          description: Schema is not in active status
        '404':
          $ref: '#/components/responses/NotFound'

  /schemas/{schemaId}/clone:
    post:
      tags: [standalone-schemas]
      summary: Clone schema to create new version
      description: |
        Create a new independent schema based on an existing one.

        **When to use:**
        - **Making breaking changes** - Clone first instead of modifying active schema
        - **Creating variations** - Base a new schema on an existing one
        - **Versioning** - Create v2 while keeping v1 active

        **Recommended workflow for breaking changes:**
        1. Clone the active schema → creates new draft
        2. Make breaking changes to the new draft
        3. Publish the new schema
        4. Update contracts to reference the new schema
        5. Deprecate the old schema

        **Response:**
        - New schema with unique ID
        - Status set to `draft`
        - Version incremented (minor bump)
        - Tracks lineage: `clonedFromSchemaId`, `clonedFromVersion`
      operationId: cloneSchema
      parameters:
        - $ref: '#/components/parameters/schemaIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SchemaCloneRequest'
      responses:
        '201':
          description: Schema cloned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandaloneSchema'
        '404':
          $ref: '#/components/responses/NotFound'

  /schemas/{schemaId}/versions:
    get:
      tags: [standalone-schemas]
      summary: Get schema version history
      description: |
        Retrieve the complete version history of a schema.

        **Response includes:**
        - List of all versions with timestamps
        - Change type (initial, update, clone)
        - Change notes
        - Who made each change
        - Pointer to current version
      operationId: getSchemaVersionHistory
      security: []
      parameters:
        - $ref: '#/components/parameters/schemaIdParam'
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Version history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaVersionHistoryResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  # ---------------------------------------------------------------------------
  # Validations
  # ---------------------------------------------------------------------------
  /validations:
    post:
      tags: [validations]
      summary: Record a validation result
      operationId: recordValidation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidationRecordRequest'
      responses:
        '201':
          description: Validation recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationRecord'

    get:
      tags: [validations]
      summary: List validation records
      operationId: listValidations
      security: []
      parameters:
        - name: contract_id
          in: query
          schema:
            type: string
        - name: schema_name
          in: query
          schema:
            type: string
        - name: passed
          in: query
          schema:
            type: boolean
        - name: from_date
          in: query
          schema:
            type: string
            format: date-time
        - name: to_date
          in: query
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Validation records
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationListResponse'

  /validations/stats/{contractId}:
    get:
      tags: [validations]
      summary: Get validation statistics
      operationId: getValidationStats
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: days
          in: query
          schema:
            type: integer
            default: 30
            minimum: 1
            maximum: 365
      responses:
        '200':
          description: Validation statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationStats'

  # ---------------------------------------------------------------------------
  # Runs
  # ---------------------------------------------------------------------------
  /runs:
    post:
      tags: [runs]
      summary: Create a run
      operationId: createRun
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunCreateRequest'
      responses:
        '201':
          description: Run created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

    get:
      tags: [runs]
      summary: List runs
      operationId: listRuns
      security: []
      parameters:
        - name: contract_id
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, completed, failed]
        - name: from_date
          in: query
          schema:
            type: string
            format: date-time
        - name: to_date
          in: query
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Run list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunListResponse'

  /runs/{runId}:
    get:
      tags: [runs]
      summary: Get a run
      operationId: getRun
      security: []
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Run details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [runs]
      summary: Update run status
      operationId: updateRunStatus
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunUpdateRequest'
      responses:
        '200':
          description: Run updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

  # ---------------------------------------------------------------------------
  # Issues
  # ---------------------------------------------------------------------------
  /issues:
    post:
      tags: [issues]
      summary: Create an issue
      operationId: createIssue
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IssueCreateRequest'
      responses:
        '201':
          description: Issue created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Issue'

    get:
      tags: [issues]
      summary: List issues
      operationId: listIssues
      security: []
      parameters:
        - name: contract_id
          in: query
          schema:
            type: string
        - name: run_id
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [open, resolved]
        - name: severity
          in: query
          schema:
            type: string
            enum: [error, warning, info]
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Issue list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IssueListResponse'

  /issues/{issueId}:
    get:
      tags: [issues]
      summary: Get an issue
      operationId: getIssue
      security: []
      parameters:
        - name: issueId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Issue details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Issue'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [issues]
      summary: Update an issue
      operationId: updateIssue
      parameters:
        - name: issueId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IssueUpdateRequest'
      responses:
        '200':
          description: Issue updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Issue'

  /issues/{issueId}/resolve:
    post:
      tags: [issues]
      summary: Resolve an issue
      operationId: resolveIssue
      parameters:
        - name: issueId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IssueResolveRequest'
      responses:
        '200':
          description: Issue resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Issue'

  # ---------------------------------------------------------------------------
  # Comments
  # ---------------------------------------------------------------------------
  /comments:
    post:
      tags: [comments]
      summary: Create a comment
      operationId: createComment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentCreateRequest'
      responses:
        '201':
          description: Comment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'

  /comments/{commentId}:
    get:
      tags: [comments]
      summary: Get a comment
      operationId: getComment
      security: []
      parameters:
        - name: commentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Comment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [comments]
      summary: Update a comment
      operationId: updateComment
      parameters:
        - name: commentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentUpdateRequest'
      responses:
        '200':
          description: Comment updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'

    delete:
      tags: [comments]
      summary: Delete a comment
      operationId: deleteComment
      parameters:
        - name: commentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Comment deleted

  /comments/{commentId}/reactions:
    post:
      tags: [comments]
      summary: Add a reaction
      operationId: addReaction
      parameters:
        - name: commentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReactionRequest'
      responses:
        '200':
          description: Reaction added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'

  /contracts/{contractId}/comments:
    get:
      tags: [comments]
      summary: List comments for a contract
      operationId: listContractComments
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: thread_id
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Comment list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentListResponse'

  # ---------------------------------------------------------------------------
  # Approvals
  # ---------------------------------------------------------------------------
  /approvals:
    post:
      tags: [approvals]
      summary: Create approval request
      operationId: createApprovalRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApprovalCreateRequest'
      responses:
        '201':
          description: Approval request created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequest'

  /approvals/pending:
    get:
      tags: [approvals]
      summary: List pending approvals
      operationId: listPendingApprovals
      parameters:
        - name: contract_id
          in: query
          schema:
            type: string
          description: Filter by contract ID
        - name: my_approvals
          in: query
          schema:
            type: boolean
            default: false
          description: Only show approvals where I'm an approver
      responses:
        '200':
          description: Pending approvals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequestList'

  /approvals/{requestId}:
    get:
      tags: [approvals]
      summary: Get approval request
      operationId: getApprovalRequest
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Approval details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /approvals/{requestId}/approve:
    post:
      tags: [approvals]
      summary: Approve request
      description: Only users listed in the approvers can approve. When all approvers have approved, the contract status is updated to 'active'.
      operationId: approveRequest
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApproveDecision'
      responses:
        '200':
          description: Request approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequest'
        '400':
          description: User not authorized to approve
        '404':
          $ref: '#/components/responses/NotFound'

  /approvals/{requestId}/reject:
    post:
      tags: [approvals]
      summary: Reject request
      description: Only users listed in the approvers can reject. A single rejection marks the entire request as rejected.
      operationId: rejectRequest
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RejectDecision'
      responses:
        '200':
          description: Request rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequest'
        '400':
          description: User not authorized to reject
        '404':
          $ref: '#/components/responses/NotFound'

  # ---------------------------------------------------------------------------
  # Search
  # ---------------------------------------------------------------------------
  /search:
    get:
      tags: [search]
      summary: Search contracts
      operationId: search
      security: []
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
            minLength: 1
        - $ref: '#/components/parameters/limitParam'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

  /search/advanced:
    get:
      tags: [search]
      summary: Advanced search
      operationId: advancedSearch
      security: []
      parameters:
        - name: query
          in: query
          schema:
            type: string
        - name: name
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
        - name: schema_name
          in: query
          schema:
            type: string
        - name: owner
          in: query
          schema:
            type: string
        - name: has_pii
          in: query
          schema:
            type: boolean
        - $ref: '#/components/parameters/limitParam'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

# =============================================================================
# COMPONENTS
# =============================================================================
components:
  parameters:
    contractIdParam:
      name: contractId
      in: path
      required: true
      schema:
        type: string

    schemaIdParam:
      name: schemaId
      in: path
      required: true
      description: Unique schema identifier (sch-xxxxxxxxxxxx)
      schema:
        type: string
        pattern: '^sch-[a-z0-9]+$'

    limitParam:
      name: limit
      in: query
      schema:
        type: integer
        default: 50
        minimum: 1
        maximum: 100

    offsetParam:
      name: offset
      in: query
      schema:
        type: integer
        default: 0
        minimum: 0

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    ValidationFailed:
      description: Validation failed
      content:
        application/json:
          schema:
            type: object
            properties:
              code:
                type: string
              message:
                type: string
              validation:
                $ref: '#/components/schemas/ContractValidationResponse'

  schemas:
    # Core
    Error:
      type: object
      properties:
        detail:
          oneOf:
            - type: string
            - type: object
              properties:
                code:
                  type: string
                message:
                  type: string

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        version:
          type: string
        storage:
          type: object

    # Auth
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          example: "user@example.com"
        password:
          type: string
          format: password
          example: "SecurePass123"
        rememberMe:
          type: boolean
          default: false
          description: Extend token validity to 30 days

    SignupRequest:
      type: object
      required: [name, email, password, confirmPassword, acceptTerms]
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          example: "John Doe"
        email:
          type: string
          format: email
          example: "user@example.com"
        password:
          type: string
          format: password
          minLength: 8
          description: "Min 8 chars, 1 uppercase, 1 lowercase, 1 number"
          example: "SecurePass123"
        confirmPassword:
          type: string
          format: password
          example: "SecurePass123"
        acceptTerms:
          type: boolean
          description: Must be true to create account

    ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email
          example: "user@example.com"

    ResetPasswordRequest:
      type: object
      required: [token, password, confirmPassword]
      properties:
        token:
          type: string
          description: Reset token from email
        password:
          type: string
          format: password
          minLength: 8
        confirmPassword:
          type: string
          format: password

    AuthResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/AuthUserResponse'
        token:
          type: string
          description: JWT access token
        expiresAt:
          type: string
          format: date-time
          description: Token expiration time

    AuthUserResponse:
      type: object
      properties:
        id:
          type: string
          example: "user-001"
        name:
          type: string
          example: "John Doe"
        email:
          type: string
          format: email
          example: "user@example.com"
        avatar:
          type: string
          nullable: true
          description: Avatar URL
        role:
          $ref: '#/components/schemas/RoleRef'
        team:
          $ref: '#/components/schemas/TeamRef'
        status:
          type: string
          enum: [active, inactive, pending]
          example: "active"
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    RoleRef:
      type: object
      properties:
        id:
          type: string
          example: "role-editor"
        name:
          type: string
          example: "Editor"

    TeamRef:
      type: object
      nullable: true
      properties:
        id:
          type: string
          example: "team-data"
        name:
          type: string
          example: "Data Team"

    AuthErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: "INVALID_CREDENTIALS"
            message:
              type: string
              example: "Invalid email or password"
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string

    TokenResponse:
      type: object
      required: [access_token, token_type]
      properties:
        access_token:
          type: string
        token_type:
          type: string
          enum: [bearer]
        refresh_token:
          type: string
          description: Optional refresh token
        expires_in:
          type: integer
          description: Token validity in seconds

    UserInfo:
      type: object
      properties:
        id:
          type: string
        roles:
          type: array
          items:
            type: string
        auth_method:
          type: string

    # ODCS Contract
    ODCSContract:
      type: object
      required: [apiVersion, kind, id, name, version, status, schema]
      properties:
        apiVersion:
          type: string
          example: "v1.0.0"
        kind:
          type: string
          enum: [DataContract]
        id:
          type: string
        name:
          type: string
        version:
          type: string
        status:
          type: string
          enum: [draft, active, deprecated, retired]
        description:
          type: string
        schema:
          type: array
          items:
            $ref: '#/components/schemas/SchemaDefinition'

    SchemaDefinition:
      type: object
      required: [name, id, logicalType]
      properties:
        name:
          type: string
        id:
          type: string
        logicalType:
          type: string
        description:
          type: string
        properties:
          type: array
          items:
            $ref: '#/components/schemas/SchemaProperty'

    SchemaProperty:
      type: object
      required: [name, logicalType]
      properties:
        name:
          type: string
        logicalType:
          type: string
          enum: [string, integer, number, boolean, timestamp, date, array, object, bytes]
        required:
          type: boolean
          default: false
        description:
          type: string

    ContractListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ODCSContract'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    ContractUpdateRequest:
      allOf:
        - $ref: '#/components/schemas/ODCSContract'
        - type: object
          properties:
            change_type:
              type: string
              enum: [patch, minor, major]
            change_notes:
              type: string

    StatusUpdateRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [draft, active, deprecated, retired]

    ContractValidationResponse:
      type: object
      properties:
        is_valid:
          type: boolean
        has_errors:
          type: boolean
        has_warnings:
          type: boolean
        error_count:
          type: integer
        warning_count:
          type: integer
        issues:
          type: array
          items:
            $ref: '#/components/schemas/ValidationIssue'

    ValidationIssue:
      type: object
      properties:
        code:
          type: string
        field:
          type: string
        message:
          type: string
        severity:
          type: string
          enum: [error, warning]
        suggestion:
          type: string

    BreakingChangesResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        breaking_changes:
          type: array
          items:
            type: object
            properties:
              change_type:
                type: string
              field:
                type: string
              description:
                type: string
              migration_hint:
                type: string
        allow_breaking_hint:
          type: string

    # Versions
    VersionListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/VersionSummary'
        total:
          type: integer

    VersionSummary:
      type: object
      properties:
        contract_id:
          type: string
        version:
          type: string
        change_type:
          type: string
        change_notes:
          type: string
        is_breaking:
          type: boolean
        created_at:
          type: string
          format: date-time
        created_by:
          type: string

    # Schema Catalog
    SchemaCatalogResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/SchemaCatalogEntry'
        total:
          type: integer

    SchemaCatalogEntry:
      type: object
      properties:
        schema_id:
          type: string
        name:
          type: string
        physical_name:
          type: string
        logical_type:
          type: string
        physical_type:
          type: string
        description:
          type: string
        contract_id:
          type: string
        contract_name:
          type: string
        contract_version:
          type: string
        contract_status:
          type: string
        field_names:
          type: array
          items:
            type: string
        field_count:
          type: integer
        has_pii:
          type: boolean

    # Validations
    ValidationRecordRequest:
      type: object
      required: [contract_id, passed, row_count]
      properties:
        contract_id:
          type: string
        contract_version:
          type: string
        schema_name:
          type: string
        passed:
          type: boolean
        row_count:
          type: integer
        error_count:
          type: integer
        error_rate:
          type: number
        duration_ms:
          type: number
        environment:
          type: string
        pipeline_id:
          type: string
        run_id:
          type: string
        sample_errors:
          type: array
          items:
            type: object

    ValidationRecord:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        contract_version:
          type: string
        schema_name:
          type: string
        passed:
          type: boolean
        row_count:
          type: integer
        error_count:
          type: integer
        error_rate:
          type: number
        duration_ms:
          type: number
        environment:
          type: string
        pipeline_id:
          type: string
        run_id:
          type: string
        recorded_at:
          type: string
          format: date-time

    ValidationListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRecord'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    ValidationStats:
      type: object
      properties:
        contract_id:
          type: string
        period_days:
          type: integer
        total_runs:
          type: integer
        passed_runs:
          type: integer
        failed_runs:
          type: integer
        pass_rate:
          type: number
        total_rows:
          type: integer
        total_errors:
          type: integer
        avg_duration_ms:
          type: number

    # Runs
    RunCreateRequest:
      type: object
      required: [contract_id]
      properties:
        contract_id:
          type: string
        contract_version:
          type: string
        schema_name:
          type: string
        pipeline_id:
          type: string
        environment:
          type: string
        trigger:
          type: string
        metadata:
          type: object

    RunUpdateRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [pending, running, completed, failed]
        result:
          type: object

    Run:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        contract_version:
          type: string
        schema_name:
          type: string
        pipeline_id:
          type: string
        environment:
          type: string
        trigger:
          type: string
        status:
          type: string
        result:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        created_by:
          type: string

    RunListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Run'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # Issues
    IssueCreateRequest:
      type: object
      required: [contract_id, title]
      properties:
        contract_id:
          type: string
        run_id:
          type: string
        title:
          type: string
        description:
          type: string
        severity:
          type: string
          enum: [error, warning, info]
          default: warning
        category:
          type: string
        affected_field:
          type: string
        affected_schema:
          type: string
        metadata:
          type: object

    IssueUpdateRequest:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        severity:
          type: string
        status:
          type: string
        assignee:
          type: string

    IssueResolveRequest:
      type: object
      required: [resolution]
      properties:
        resolution:
          type: string

    Issue:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        run_id:
          type: string
        title:
          type: string
        description:
          type: string
        severity:
          type: string
        category:
          type: string
        status:
          type: string
        affected_field:
          type: string
        affected_schema:
          type: string
        assignee:
          type: string
        resolution:
          type: string
        resolved_by:
          type: string
        resolved_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by:
          type: string

    IssueListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Issue'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # Comments
    CommentCreateRequest:
      type: object
      required: [contract_id, content]
      properties:
        contract_id:
          type: string
        content:
          type: string
          minLength: 1
          maxLength: 5000
        thread_id:
          type: string
        section:
          type: string
        field_path:
          type: string

    CommentUpdateRequest:
      type: object
      required: [content]
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 5000

    ReactionRequest:
      type: object
      required: [reaction]
      properties:
        reaction:
          type: string

    Comment:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        content:
          type: string
        thread_id:
          type: string
        section:
          type: string
        field_path:
          type: string
        reactions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by:
          type: string
        updated_by:
          type: string

    CommentListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Comment'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # Approvals
    ApprovalCreateRequest:
      type: object
      required: [contract_id, approvers]
      properties:
        contract_id:
          type: string
        approvers:
          type: array
          items:
            type: string
          minItems: 1
          description: List of user IDs who need to approve
        notes:
          type: string
          description: Notes about the approval request

    ApproveDecision:
      type: object
      properties:
        comments:
          type: string

    RejectDecision:
      type: object
      required: [reason]
      properties:
        reason:
          type: string
          minLength: 1
          description: Reason for rejection

    ApprovalEntry:
      type: object
      properties:
        approver:
          type: string
        comments:
          type: string
        approved_at:
          type: string
          format: date-time

    RejectionEntry:
      type: object
      properties:
        rejector:
          type: string
        reason:
          type: string
        rejected_at:
          type: string
          format: date-time

    ApprovalRequest:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        requested_by:
          type: string
        approvers:
          type: array
          items:
            type: string
        notes:
          type: string
        status:
          type: string
          enum: [pending, approved, rejected]
        approvals:
          type: array
          items:
            $ref: '#/components/schemas/ApprovalEntry'
        rejections:
          type: array
          items:
            $ref: '#/components/schemas/RejectionEntry'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time

    ApprovalRequestList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ApprovalRequest'

    # Search
    SearchResponse:
      type: object
      properties:
        query:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/SearchHit'
        total:
          type: integer

    SearchHit:
      type: object
      properties:
        contract_id:
          type: string
        contract_name:
          type: string
        version:
          type: string
        status:
          type: string
        score:
          type: number
        match_type:
          type: string
        snippet:
          type: string

    # =========================================================================
    # Standalone Schema Components
    # =========================================================================
    StandaloneSchemaCreateRequest:
      type: object
      required: [name, logicalType, properties]
      properties:
        name:
          type: string
          description: Unique schema name (lowercase, no spaces)
          example: "customers"
        physicalName:
          type: string
          description: Physical name in data system (e.g., table name)
          example: "dim_customers"
        logicalType:
          type: string
          enum: [object, array, primitive]
          example: "object"
        physicalType:
          type: string
          description: Physical data type (e.g., table, topic, file)
          example: "table"
        description:
          type: string
          example: "Customer dimension table for analytics"
        businessName:
          type: string
          description: Business-friendly display name
          example: "Customers"
        domain:
          type: string
          description: Business domain
          example: "analytics"
        tags:
          type: array
          items:
            type: string
          example: ["finance", "pii"]
        ownerTeamId:
          type: string
          description: Team that owns this schema
        properties:
          type: array
          items:
            $ref: '#/components/schemas/StandaloneSchemaProperty'
          minItems: 1

    StandaloneSchemaUpdateRequest:
      type: object
      properties:
        name:
          type: string
        physicalName:
          type: string
        description:
          type: string
        businessName:
          type: string
        domain:
          type: string
        tags:
          type: array
          items:
            type: string
        properties:
          type: array
          items:
            $ref: '#/components/schemas/StandaloneSchemaProperty'
        forceBreaking:
          type: boolean
          description: Admin-only flag to force update despite breaking changes
          default: false

    SchemaDeprecateRequest:
      type: object
      required: [reason]
      properties:
        reason:
          type: string
          minLength: 1
          description: Reason for deprecation
          example: "Replaced by customers_v2 schema"
        replacementSchemaId:
          type: string
          description: ID of schema that replaces this one
          example: "sch-newschema789"

    SchemaCloneRequest:
      type: object
      required: [changeNotes]
      properties:
        changeNotes:
          type: string
          minLength: 1
          description: Notes describing why cloning and what will change
          example: "Adding GDPR compliance fields"

    StandaloneSchemaProperty:
      type: object
      required: [name, logicalType]
      properties:
        name:
          type: string
          description: Property/column name
          example: "customer_id"
        logicalType:
          type: string
          description: Logical data type
          example: "string"
        physicalType:
          type: string
          description: Physical data type
          example: "VARCHAR(50)"
        description:
          type: string
          example: "Unique customer identifier"
        primaryKey:
          type: boolean
          default: false
        required:
          type: boolean
          default: false
        nullable:
          type: boolean
          default: true
        unique:
          type: boolean
          default: false
        defaultValue:
          type: string
        customProperties:
          type: object
          additionalProperties: true
          description: Custom metadata (e.g., privacy settings)
          example:
            privacy:
              is_pii: true
              pii_type: "direct_identifier"

    StandaloneSchema:
      type: object
      properties:
        id:
          type: string
          description: Unique schema identifier
          example: "sch-abc123def456"
        name:
          type: string
          example: "customers"
        physicalName:
          type: string
          example: "dim_customers"
        logicalType:
          type: string
          example: "object"
        physicalType:
          type: string
          example: "table"
        description:
          type: string
        businessName:
          type: string
        domain:
          type: string
        tags:
          type: array
          items:
            type: string
        properties:
          type: array
          items:
            $ref: '#/components/schemas/StandaloneSchemaProperty'
        version:
          type: string
          description: Semantic version
          example: "1.0.0"
        status:
          type: string
          enum: [draft, active, deprecated]
          example: "draft"
        ownerId:
          type: string
          description: User who owns this schema
        ownerTeamId:
          type: string
          description: Team that owns this schema
        source:
          type: string
          enum: [manual, connection, import]
        connectionId:
          type: string
          description: Database connection ID (if source is connection)
        propertyCount:
          type: integer
        hasPii:
          type: boolean
          description: Whether any properties contain PII
        clonedFromSchemaId:
          type: string
          description: ID of schema this was cloned from
        clonedFromVersion:
          type: string
          description: Version of schema this was cloned from
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
        updatedAt:
          type: string
          format: date-time
        updatedBy:
          type: string

    StandaloneSchemaListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/StandaloneSchema'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    SchemaVersionHistoryResponse:
      type: object
      properties:
        schemaId:
          type: string
        currentVersion:
          type: string
        versions:
          type: array
          items:
            $ref: '#/components/schemas/SchemaVersionEntry'
        total:
          type: integer

    SchemaVersionEntry:
      type: object
      properties:
        version:
          type: string
          example: "1.0.0"
        changeType:
          type: string
          enum: [initial, update, clone]
        changeNotes:
          type: string
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
        isCurrent:
          type: boolean
        clonedFrom:
          type: object
          properties:
            schemaId:
              type: string
            version:
              type: string

    SchemaBreakingChangesError:
      type: object
      properties:
        detail:
          type: object
          properties:
            code:
              type: string
              example: "BREAKING_CHANGES_DETECTED"
            message:
              type: string
              example: "Breaking changes detected. Use forceBreaking=true or clone the schema."
            breakingChanges:
              type: array
              items:
                type: object
                properties:
                  type:
                    type: string
                    enum: [column_removed, type_changed, nullable_to_required]
                  column:
                    type: string
                  description:
                    type: string
            affectedContracts:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
            suggestions:
              type: array
              items:
                type: string

    SchemaInUseError:
      type: object
      properties:
        detail:
          type: object
          properties:
            code:
              type: string
              example: "SCHEMA_IN_USE"
            message:
              type: string
              example: "Cannot delete schema 'sch-abc123' - it is used by 2 contract(s)"
            contracts:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - bearerAuth: []
