# =============================================================================
# GRIOT REGISTRY API SPECIFICATION
# =============================================================================
# Owner: registry agent
# Consumers: hub, cli (for push/pull)
#
# OpenAPI 3.0 specification for griot-registry REST API
# Updated: 2026-01-22 - All endpoints tested and verified
# =============================================================================

openapi: "3.0.3"
info:
  title: Griot Registry API
  description: |
    Central registry for Griot data contracts. Provides storage, versioning,
    validation, approval workflows, and collaboration features for ODCS-compliant
    data contracts.

    ## Authentication

    Most write operations require JWT authentication. Obtain a token via:
    ```
    GET /api/v1/auth/token?user_id=myuser&roles=editor
    ```

    Include the token in requests:
    ```
    Authorization: Bearer <token>
    ```

    ## Contract Format (ODCS)

    Contracts use the Open Data Contract Standard (ODCS) format:
    ```json
    {
      "apiVersion": "v1.0.0",
      "kind": "DataContract",
      "id": "unique-id",
      "name": "contract_name",
      "version": "1.0.0",
      "status": "draft",
      "schema": [...]
    }
    ```
  version: "0.2.0"
  contact:
    name: Griot Team
  license:
    name: Apache 2.0

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: health
    description: Service health checks
  - name: auth
    description: Authentication and authorization
  - name: contracts
    description: Contract CRUD operations
  - name: versions
    description: Contract versioning
  - name: schemas
    description: Schema catalog queries
  - name: validations
    description: Validation records
  - name: runs
    description: Pipeline run tracking
  - name: issues
    description: Issue management
  - name: comments
    description: Collaboration comments
  - name: approvals
    description: Approval workflows
  - name: search
    description: Search contracts

# =============================================================================
# PATHS
# =============================================================================
paths:
  # ---------------------------------------------------------------------------
  # Health
  # ---------------------------------------------------------------------------
  /health:
    get:
      tags: [health]
      summary: Health check
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: Service health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/live:
    get:
      tags: [health]
      summary: Liveness probe
      operationId: livenessCheck
      security: []
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "alive"

  /health/ready:
    get:
      tags: [health]
      summary: Readiness probe
      operationId: readinessCheck
      security: []
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ready, not ready]

  # ---------------------------------------------------------------------------
  # Authentication
  # ---------------------------------------------------------------------------
  /auth/token:
    get:
      tags: [auth]
      summary: Get JWT access token
      operationId: getToken
      security: []
      parameters:
        - name: user_id
          in: query
          required: true
          schema:
            type: string
          description: User identifier
        - name: roles
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
              enum: [viewer, editor, admin]
          style: form
          explode: true
          description: User roles
      responses:
        '200':
          description: Token generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'

  /auth/me:
    get:
      tags: [auth]
      summary: Get current user info
      operationId: getCurrentUser
      responses:
        '200':
          description: Current user information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ---------------------------------------------------------------------------
  # Contracts
  # ---------------------------------------------------------------------------
  /contracts:
    get:
      tags: [contracts]
      summary: List all contracts
      operationId: listContracts
      security: []
      parameters:
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, active, deprecated, retired]
        - name: schema_name
          in: query
          schema:
            type: string
        - name: owner
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of contracts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContractListResponse'

    post:
      tags: [contracts]
      summary: Create new contract
      operationId: createContract
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ODCSContract'
      responses:
        '201':
          description: Contract created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Contract already exists
        '422':
          $ref: '#/components/responses/ValidationFailed'

  /contracts/validate:
    post:
      tags: [contracts]
      summary: Validate contract without storing
      operationId: validateContract
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ODCSContract'
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContractValidationResponse'

  /contracts/{contractId}:
    get:
      tags: [contracts]
      summary: Get contract by ID
      operationId: getContract
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: version
          in: query
          schema:
            type: string
          description: Specific version to retrieve
      responses:
        '200':
          description: Contract details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [contracts]
      summary: Update contract (creates new version)
      operationId: updateContract
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: allow_breaking
          in: query
          schema:
            type: boolean
            default: false
          description: Allow breaking changes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContractUpdateRequest'
      responses:
        '200':
          description: Contract updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '409':
          description: Breaking changes detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BreakingChangesResponse'

    delete:
      tags: [contracts]
      summary: Deprecate contract
      operationId: deprecateContract
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
      responses:
        '204':
          description: Contract deprecated
        '404':
          $ref: '#/components/responses/NotFound'

  /contracts/{contractId}/status:
    patch:
      tags: [contracts]
      summary: Update contract status
      operationId: updateContractStatus
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StatusUpdateRequest'
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '400':
          description: Invalid status transition

  # ---------------------------------------------------------------------------
  # Versions
  # ---------------------------------------------------------------------------
  /contracts/{contractId}/versions:
    get:
      tags: [versions]
      summary: List contract versions
      operationId: listVersions
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Version list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionListResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /contracts/{contractId}/versions/{version}:
    get:
      tags: [versions]
      summary: Get specific version
      operationId: getVersion
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: version
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Contract at version
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ODCSContract'
        '404':
          $ref: '#/components/responses/NotFound'

  # ---------------------------------------------------------------------------
  # Schemas
  # ---------------------------------------------------------------------------
  /schemas:
    get:
      tags: [schemas]
      summary: Find schemas across contracts
      operationId: findSchemas
      security: []
      parameters:
        - name: name
          in: query
          schema:
            type: string
          description: Filter by schema name
        - name: physical_name
          in: query
          schema:
            type: string
          description: Filter by physical table name
        - name: field_name
          in: query
          schema:
            type: string
          description: Filter by field name
        - name: has_pii
          in: query
          schema:
            type: boolean
          description: Filter by PII flag
        - $ref: '#/components/parameters/limitParam'
      responses:
        '200':
          description: Schema catalog entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaCatalogResponse'

  /schemas/contracts/{schemaName}:
    get:
      tags: [schemas]
      summary: Get contracts containing a schema
      operationId: getContractsBySchema
      security: []
      parameters:
        - name: schemaName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Contract IDs
          content:
            application/json:
              schema:
                type: object
                properties:
                  schema_name:
                    type: string
                  contract_ids:
                    type: array
                    items:
                      type: string
                  count:
                    type: integer

  /schemas/rebuild:
    post:
      tags: [schemas]
      summary: Rebuild schema catalog
      operationId: rebuildSchemaCatalog
      responses:
        '200':
          description: Catalog rebuilt
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  schemas_indexed:
                    type: integer

  # ---------------------------------------------------------------------------
  # Validations
  # ---------------------------------------------------------------------------
  /validations:
    post:
      tags: [validations]
      summary: Record a validation result
      operationId: recordValidation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidationRecordRequest'
      responses:
        '201':
          description: Validation recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationRecord'

    get:
      tags: [validations]
      summary: List validation records
      operationId: listValidations
      security: []
      parameters:
        - name: contract_id
          in: query
          schema:
            type: string
        - name: schema_name
          in: query
          schema:
            type: string
        - name: passed
          in: query
          schema:
            type: boolean
        - name: from_date
          in: query
          schema:
            type: string
            format: date-time
        - name: to_date
          in: query
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Validation records
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationListResponse'

  /validations/stats/{contractId}:
    get:
      tags: [validations]
      summary: Get validation statistics
      operationId: getValidationStats
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: days
          in: query
          schema:
            type: integer
            default: 30
            minimum: 1
            maximum: 365
      responses:
        '200':
          description: Validation statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationStats'

  # ---------------------------------------------------------------------------
  # Runs
  # ---------------------------------------------------------------------------
  /runs:
    post:
      tags: [runs]
      summary: Create a run
      operationId: createRun
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunCreateRequest'
      responses:
        '201':
          description: Run created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

    get:
      tags: [runs]
      summary: List runs
      operationId: listRuns
      security: []
      parameters:
        - name: contract_id
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, completed, failed]
        - name: from_date
          in: query
          schema:
            type: string
            format: date-time
        - name: to_date
          in: query
          schema:
            type: string
            format: date-time
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Run list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunListResponse'

  /runs/{runId}:
    get:
      tags: [runs]
      summary: Get a run
      operationId: getRun
      security: []
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Run details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [runs]
      summary: Update run status
      operationId: updateRunStatus
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunUpdateRequest'
      responses:
        '200':
          description: Run updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Run'

  # ---------------------------------------------------------------------------
  # Issues
  # ---------------------------------------------------------------------------
  /issues:
    post:
      tags: [issues]
      summary: Create an issue
      operationId: createIssue
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IssueCreateRequest'
      responses:
        '201':
          description: Issue created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Issue'

    get:
      tags: [issues]
      summary: List issues
      operationId: listIssues
      security: []
      parameters:
        - name: contract_id
          in: query
          schema:
            type: string
        - name: run_id
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [open, resolved]
        - name: severity
          in: query
          schema:
            type: string
            enum: [error, warning, info]
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Issue list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IssueListResponse'

  /issues/{issueId}:
    get:
      tags: [issues]
      summary: Get an issue
      operationId: getIssue
      security: []
      parameters:
        - name: issueId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Issue details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Issue'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [issues]
      summary: Update an issue
      operationId: updateIssue
      parameters:
        - name: issueId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IssueUpdateRequest'
      responses:
        '200':
          description: Issue updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Issue'

  /issues/{issueId}/resolve:
    post:
      tags: [issues]
      summary: Resolve an issue
      operationId: resolveIssue
      parameters:
        - name: issueId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IssueResolveRequest'
      responses:
        '200':
          description: Issue resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Issue'

  # ---------------------------------------------------------------------------
  # Comments
  # ---------------------------------------------------------------------------
  /comments:
    post:
      tags: [comments]
      summary: Create a comment
      operationId: createComment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentCreateRequest'
      responses:
        '201':
          description: Comment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'

  /comments/{commentId}:
    get:
      tags: [comments]
      summary: Get a comment
      operationId: getComment
      security: []
      parameters:
        - name: commentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Comment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [comments]
      summary: Update a comment
      operationId: updateComment
      parameters:
        - name: commentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentUpdateRequest'
      responses:
        '200':
          description: Comment updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'

    delete:
      tags: [comments]
      summary: Delete a comment
      operationId: deleteComment
      parameters:
        - name: commentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Comment deleted

  /comments/{commentId}/reactions:
    post:
      tags: [comments]
      summary: Add a reaction
      operationId: addReaction
      parameters:
        - name: commentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReactionRequest'
      responses:
        '200':
          description: Reaction added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'

  /contracts/{contractId}/comments:
    get:
      tags: [comments]
      summary: List comments for a contract
      operationId: listContractComments
      security: []
      parameters:
        - $ref: '#/components/parameters/contractIdParam'
        - name: thread_id
          in: query
          schema:
            type: string
        - $ref: '#/components/parameters/limitParam'
        - $ref: '#/components/parameters/offsetParam'
      responses:
        '200':
          description: Comment list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentListResponse'

  # ---------------------------------------------------------------------------
  # Approvals
  # ---------------------------------------------------------------------------
  /approvals:
    post:
      tags: [approvals]
      summary: Create approval request
      operationId: createApprovalRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApprovalCreateRequest'
      responses:
        '201':
          description: Approval request created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequest'

  /approvals/pending:
    get:
      tags: [approvals]
      summary: List pending approvals
      operationId: listPendingApprovals
      parameters:
        - name: contract_id
          in: query
          schema:
            type: string
          description: Filter by contract ID
        - name: my_approvals
          in: query
          schema:
            type: boolean
            default: false
          description: Only show approvals where I'm an approver
      responses:
        '200':
          description: Pending approvals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequestList'

  /approvals/{requestId}:
    get:
      tags: [approvals]
      summary: Get approval request
      operationId: getApprovalRequest
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Approval details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /approvals/{requestId}/approve:
    post:
      tags: [approvals]
      summary: Approve request
      description: Only users listed in the approvers can approve. When all approvers have approved, the contract status is updated to 'active'.
      operationId: approveRequest
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApproveDecision'
      responses:
        '200':
          description: Request approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequest'
        '400':
          description: User not authorized to approve
        '404':
          $ref: '#/components/responses/NotFound'

  /approvals/{requestId}/reject:
    post:
      tags: [approvals]
      summary: Reject request
      description: Only users listed in the approvers can reject. A single rejection marks the entire request as rejected.
      operationId: rejectRequest
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RejectDecision'
      responses:
        '200':
          description: Request rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequest'
        '400':
          description: User not authorized to reject
        '404':
          $ref: '#/components/responses/NotFound'

  # ---------------------------------------------------------------------------
  # Search
  # ---------------------------------------------------------------------------
  /search:
    get:
      tags: [search]
      summary: Search contracts
      operationId: search
      security: []
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
            minLength: 1
        - $ref: '#/components/parameters/limitParam'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

  /search/advanced:
    get:
      tags: [search]
      summary: Advanced search
      operationId: advancedSearch
      security: []
      parameters:
        - name: query
          in: query
          schema:
            type: string
        - name: name
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
        - name: schema_name
          in: query
          schema:
            type: string
        - name: owner
          in: query
          schema:
            type: string
        - name: has_pii
          in: query
          schema:
            type: boolean
        - $ref: '#/components/parameters/limitParam'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

# =============================================================================
# COMPONENTS
# =============================================================================
components:
  parameters:
    contractIdParam:
      name: contractId
      in: path
      required: true
      schema:
        type: string

    limitParam:
      name: limit
      in: query
      schema:
        type: integer
        default: 50
        minimum: 1
        maximum: 100

    offsetParam:
      name: offset
      in: query
      schema:
        type: integer
        default: 0
        minimum: 0

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    ValidationFailed:
      description: Validation failed
      content:
        application/json:
          schema:
            type: object
            properties:
              code:
                type: string
              message:
                type: string
              validation:
                $ref: '#/components/schemas/ContractValidationResponse'

  schemas:
    # Core
    Error:
      type: object
      properties:
        detail:
          oneOf:
            - type: string
            - type: object
              properties:
                code:
                  type: string
                message:
                  type: string

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        version:
          type: string
        storage:
          type: object

    # Auth
    TokenResponse:
      type: object
      required: [access_token, token_type]
      properties:
        access_token:
          type: string
        token_type:
          type: string
          enum: [bearer]

    UserInfo:
      type: object
      properties:
        id:
          type: string
        roles:
          type: array
          items:
            type: string
        auth_method:
          type: string

    # ODCS Contract
    ODCSContract:
      type: object
      required: [apiVersion, kind, id, name, version, status, schema]
      properties:
        apiVersion:
          type: string
          example: "v1.0.0"
        kind:
          type: string
          enum: [DataContract]
        id:
          type: string
        name:
          type: string
        version:
          type: string
        status:
          type: string
          enum: [draft, active, deprecated, retired]
        description:
          type: string
        schema:
          type: array
          items:
            $ref: '#/components/schemas/SchemaDefinition'

    SchemaDefinition:
      type: object
      required: [name, id, logicalType]
      properties:
        name:
          type: string
        id:
          type: string
        logicalType:
          type: string
        description:
          type: string
        properties:
          type: array
          items:
            $ref: '#/components/schemas/SchemaProperty'

    SchemaProperty:
      type: object
      required: [name, logicalType]
      properties:
        name:
          type: string
        logicalType:
          type: string
          enum: [string, integer, number, boolean, timestamp, date, array, object, bytes]
        required:
          type: boolean
          default: false
        description:
          type: string

    ContractListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ODCSContract'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    ContractUpdateRequest:
      allOf:
        - $ref: '#/components/schemas/ODCSContract'
        - type: object
          properties:
            change_type:
              type: string
              enum: [patch, minor, major]
            change_notes:
              type: string

    StatusUpdateRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [draft, active, deprecated, retired]

    ContractValidationResponse:
      type: object
      properties:
        is_valid:
          type: boolean
        has_errors:
          type: boolean
        has_warnings:
          type: boolean
        error_count:
          type: integer
        warning_count:
          type: integer
        issues:
          type: array
          items:
            $ref: '#/components/schemas/ValidationIssue'

    ValidationIssue:
      type: object
      properties:
        code:
          type: string
        field:
          type: string
        message:
          type: string
        severity:
          type: string
          enum: [error, warning]
        suggestion:
          type: string

    BreakingChangesResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        breaking_changes:
          type: array
          items:
            type: object
            properties:
              change_type:
                type: string
              field:
                type: string
              description:
                type: string
              migration_hint:
                type: string
        allow_breaking_hint:
          type: string

    # Versions
    VersionListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/VersionSummary'
        total:
          type: integer

    VersionSummary:
      type: object
      properties:
        contract_id:
          type: string
        version:
          type: string
        change_type:
          type: string
        change_notes:
          type: string
        is_breaking:
          type: boolean
        created_at:
          type: string
          format: date-time
        created_by:
          type: string

    # Schema Catalog
    SchemaCatalogResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/SchemaCatalogEntry'
        total:
          type: integer

    SchemaCatalogEntry:
      type: object
      properties:
        schema_id:
          type: string
        name:
          type: string
        physical_name:
          type: string
        logical_type:
          type: string
        physical_type:
          type: string
        description:
          type: string
        contract_id:
          type: string
        contract_name:
          type: string
        contract_version:
          type: string
        contract_status:
          type: string
        field_names:
          type: array
          items:
            type: string
        field_count:
          type: integer
        has_pii:
          type: boolean

    # Validations
    ValidationRecordRequest:
      type: object
      required: [contract_id, passed, row_count]
      properties:
        contract_id:
          type: string
        contract_version:
          type: string
        schema_name:
          type: string
        passed:
          type: boolean
        row_count:
          type: integer
        error_count:
          type: integer
        error_rate:
          type: number
        duration_ms:
          type: number
        environment:
          type: string
        pipeline_id:
          type: string
        run_id:
          type: string
        sample_errors:
          type: array
          items:
            type: object

    ValidationRecord:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        contract_version:
          type: string
        schema_name:
          type: string
        passed:
          type: boolean
        row_count:
          type: integer
        error_count:
          type: integer
        error_rate:
          type: number
        duration_ms:
          type: number
        environment:
          type: string
        pipeline_id:
          type: string
        run_id:
          type: string
        recorded_at:
          type: string
          format: date-time

    ValidationListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRecord'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    ValidationStats:
      type: object
      properties:
        contract_id:
          type: string
        period_days:
          type: integer
        total_runs:
          type: integer
        passed_runs:
          type: integer
        failed_runs:
          type: integer
        pass_rate:
          type: number
        total_rows:
          type: integer
        total_errors:
          type: integer
        avg_duration_ms:
          type: number

    # Runs
    RunCreateRequest:
      type: object
      required: [contract_id]
      properties:
        contract_id:
          type: string
        contract_version:
          type: string
        schema_name:
          type: string
        pipeline_id:
          type: string
        environment:
          type: string
        trigger:
          type: string
        metadata:
          type: object

    RunUpdateRequest:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [pending, running, completed, failed]
        result:
          type: object

    Run:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        contract_version:
          type: string
        schema_name:
          type: string
        pipeline_id:
          type: string
        environment:
          type: string
        trigger:
          type: string
        status:
          type: string
        result:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        created_by:
          type: string

    RunListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Run'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # Issues
    IssueCreateRequest:
      type: object
      required: [contract_id, title]
      properties:
        contract_id:
          type: string
        run_id:
          type: string
        title:
          type: string
        description:
          type: string
        severity:
          type: string
          enum: [error, warning, info]
          default: warning
        category:
          type: string
        affected_field:
          type: string
        affected_schema:
          type: string
        metadata:
          type: object

    IssueUpdateRequest:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        severity:
          type: string
        status:
          type: string
        assignee:
          type: string

    IssueResolveRequest:
      type: object
      required: [resolution]
      properties:
        resolution:
          type: string

    Issue:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        run_id:
          type: string
        title:
          type: string
        description:
          type: string
        severity:
          type: string
        category:
          type: string
        status:
          type: string
        affected_field:
          type: string
        affected_schema:
          type: string
        assignee:
          type: string
        resolution:
          type: string
        resolved_by:
          type: string
        resolved_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by:
          type: string

    IssueListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Issue'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # Comments
    CommentCreateRequest:
      type: object
      required: [contract_id, content]
      properties:
        contract_id:
          type: string
        content:
          type: string
          minLength: 1
          maxLength: 5000
        thread_id:
          type: string
        section:
          type: string
        field_path:
          type: string

    CommentUpdateRequest:
      type: object
      required: [content]
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 5000

    ReactionRequest:
      type: object
      required: [reaction]
      properties:
        reaction:
          type: string

    Comment:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        content:
          type: string
        thread_id:
          type: string
        section:
          type: string
        field_path:
          type: string
        reactions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by:
          type: string
        updated_by:
          type: string

    CommentListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Comment'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    # Approvals
    ApprovalCreateRequest:
      type: object
      required: [contract_id, approvers]
      properties:
        contract_id:
          type: string
        approvers:
          type: array
          items:
            type: string
          minItems: 1
          description: List of user IDs who need to approve
        notes:
          type: string
          description: Notes about the approval request

    ApproveDecision:
      type: object
      properties:
        comments:
          type: string

    RejectDecision:
      type: object
      required: [reason]
      properties:
        reason:
          type: string
          minLength: 1
          description: Reason for rejection

    ApprovalEntry:
      type: object
      properties:
        approver:
          type: string
        comments:
          type: string
        approved_at:
          type: string
          format: date-time

    RejectionEntry:
      type: object
      properties:
        rejector:
          type: string
        reason:
          type: string
        rejected_at:
          type: string
          format: date-time

    ApprovalRequest:
      type: object
      properties:
        id:
          type: string
        contract_id:
          type: string
        requested_by:
          type: string
        approvers:
          type: array
          items:
            type: string
        notes:
          type: string
        status:
          type: string
          enum: [pending, approved, rejected]
        approvals:
          type: array
          items:
            $ref: '#/components/schemas/ApprovalEntry'
        rejections:
          type: array
          items:
            $ref: '#/components/schemas/RejectionEntry'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time

    ApprovalRequestList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ApprovalRequest'

    # Search
    SearchResponse:
      type: object
      properties:
        query:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/SearchHit'
        total:
          type: integer

    SearchHit:
      type: object
      properties:
        contract_id:
          type: string
        contract_name:
          type: string
        version:
          type: string
        status:
          type: string
        score:
          type: number
        match_type:
          type: string
        snippet:
          type: string

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - bearerAuth: []
