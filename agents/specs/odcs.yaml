# =============================================================================
# OPEN DATA CONTRACT STANDARD (ODCS) SPECIFICATION
# =============================================================================
# Owner: orchestrator
# Consumers: core, cli, registry, hub
#
# This spec defines the target contract schema based on the Open Data Contract
# Standard. All modules should implement support for this schema.
# =============================================================================

version: "1.0.0"
spec_version: "1.0"
created: "2026-01-11"
created_by: orchestrator

# =============================================================================
# SCHEMA OVERVIEW
# =============================================================================
# The ODCS contract has the following top-level sections:
#
# 1. Contract Metadata (required): api_version, kind, id, name, version, status
# 2. Description (required): purpose, usage, limitations, customProperties
# 3. Schema (required): Dataset/table definitions with fields
# 4. Quality (optional): Data quality rules
# 5. Legal (optional): Legal/regulatory information
# 6. Compliance (optional): Compliance requirements
# 7. Lineage (optional): Data lineage/provenance
# 8. SLA (optional): Service level agreements
# 9. Access (optional): Access control configuration
# 10. Distribution (optional): Data distribution channels
# 11. Governance (optional): Governance and ownership
# 12. Team (optional): Responsible team information
# 13. Servers (optional): Infrastructure/server definitions
# 14. Roles (optional): Role-based access definitions
# 15. Timestamps (required): Audit timestamps
# =============================================================================

# =============================================================================
# ENUMS (types.py)
# =============================================================================
enums:
  ContractStatus:
    description: Contract lifecycle status
    values:
      - draft       # Not yet active
      - active      # Published and in use
      - deprecated  # Marked for removal
      - retired     # No longer available

  PhysicalType:
    description: Physical storage type of schema
    values:
      - table
      - view
      - file
      - stream

  QualityRuleType:
    description: Types of data quality rules
    values:
      - completeness
      - accuracy
      - freshness
      - volume
      - distribution

  CheckType:
    description: Custom check implementation types
    values:
      - sql
      - python
      - great_expectations

  CheckSeverity:
    description: Custom check severity levels
    values:
      - error
      - warning

  ExtractionMethod:
    description: Data extraction methods for lineage
    values:
      - full
      - incremental
      - cdc

  PartitioningStrategy:
    description: Data partitioning strategies
    values:
      - date
      - hash
      - range

  ReviewCadence:
    description: Governance review frequency
    values:
      - monthly
      - quarterly
      - annually

  AccessLevel:
    description: Access permission levels
    values:
      - read
      - write
      - admin
      - denied

  DistributionType:
    description: Data distribution channel types
    values:
      - warehouse
      - lake
      - api
      - stream
      - file

  SourceType:
    description: Lineage source types
    values:
      - system
      - contract
      - file
      - api
      - stream

# =============================================================================
# DATACLASSES (models.py or odcs_schema.py)
# =============================================================================
dataclasses:
  # ---------------------------------------------------------------------------
  # Contract Metadata
  # ---------------------------------------------------------------------------
  ContractMetadata:
    description: Top-level contract identification and versioning
    fields:
      - name: api_version
        type: str
        required: true
        description: "ODCS schema version (e.g., 'v1.0.0')"
        default: "v1.0.0"
      - name: kind
        type: str
        required: true
        description: "Always 'DataContract'"
        default: "DataContract"
      - name: id
        type: str
        required: true
        description: Unique identifier for the contract
      - name: name
        type: str
        required: true
        description: Human-readable name
      - name: version
        type: str
        required: true
        description: "Semantic version (MAJOR.MINOR.PATCH)"
        default: "1.0.0"
      - name: status
        type: ContractStatus
        required: true
        description: Contract lifecycle status
        default: draft

  # ---------------------------------------------------------------------------
  # Description Section
  # ---------------------------------------------------------------------------
  CustomProperty:
    description: Custom key-value property with description
    fields:
      - name: name
        type: str
        required: true
      - name: value
        type: str
        required: true
      - name: description
        type: str
        required: false

  Description:
    description: Contract description and documentation
    fields:
      - name: purpose
        type: str
        required: true
        description: Why this contract exists
      - name: usage
        type: str
        required: false
        description: Intended use cases
      - name: limitations
        type: str
        required: false
        description: Known limitations or caveats
      - name: custom_properties
        type: list[CustomProperty]
        required: false
        description: Optional custom key-value pairs

  # ---------------------------------------------------------------------------
  # Schema Section
  # ---------------------------------------------------------------------------
  ForeignKey:
    description: Foreign key reference to another contract
    fields:
      - name: contract
        type: str
        required: true
        description: Referenced contract ID
      - name: field
        type: str
        required: true
        description: Referenced field name

  FieldConstraints:
    description: Field-level validation constraints
    fields:
      - name: pattern
        type: str
        required: false
        description: Regex for string validation
      - name: min_length
        type: int
        required: false
      - name: max_length
        type: int
        required: false
      - name: enum
        type: list[Any]
        required: false
        description: List of allowed values
      - name: unique
        type: bool
        required: false
        default: false
      - name: ge
        type: float
        required: false
        description: Greater than or equal
      - name: le
        type: float
        required: false
        description: Less than or equal
      - name: gt
        type: float
        required: false
        description: Greater than
      - name: lt
        type: float
        required: false
        description: Less than
      - name: multiple_of
        type: float
        required: false

  SemanticMetadata:
    description: Field semantic/business metadata
    fields:
      - name: description
        type: str
        required: false
        description: Plain-language explanation
      - name: unit
        type: str
        required: false
        description: Unit of measure
      - name: precision
        type: int
        required: false
        description: Decimal places of significance
      - name: business_term
        type: str
        required: false
        description: Business glossary term
      - name: glossary_uri
        type: str
        required: false
        description: Link to business glossary

  PrivacyMetadata:
    description: Field privacy/PII metadata
    fields:
      - name: contains_pii
        type: bool
        required: false
        default: false
      - name: pii_category
        type: PIICategory
        required: false
        description: Type of PII if contains_pii is true
      - name: sensitivity_level
        type: SensitivityLevel
        required: false
        default: internal
      - name: masking
        type: MaskingStrategy
        required: false
        default: none
      - name: retention_days
        type: int
        required: false
        description: Number of days to retain data
      - name: legal_basis
        type: LegalBasis
        required: false
        description: Legal basis for processing

  SchemaProperty:
    description: Individual field/property in schema
    fields:
      - name: name
        type: str
        required: true
      - name: description
        type: str
        required: false
      - name: logical_type
        type: str
        required: true
        description: "Logical type (string, integer, date, etc.)"
      - name: physical_type
        type: str
        required: false
        description: Physical type in the data store
      - name: nullable
        type: bool
        required: false
        default: true
      - name: examples
        type: list[Any]
        required: false
      - name: primary_key
        type: bool
        required: false
        default: false
      - name: foreign_key
        type: ForeignKey
        required: false
      - name: constraints
        type: FieldConstraints
        required: false
      - name: semantic
        type: SemanticMetadata
        required: false
      - name: privacy
        type: PrivacyMetadata
        required: false

  Schema:
    description: Dataset/table schema definition
    fields:
      - name: name
        type: str
        required: true
        description: Name of the dataset/table
      - name: physical_type
        type: PhysicalType
        required: false
        default: table
      - name: properties
        type: list[SchemaProperty]
        required: true

  # ---------------------------------------------------------------------------
  # Quality Section
  # ---------------------------------------------------------------------------
  CompletenessRule:
    description: Check for missing values
    fields:
      - name: min_percent
        type: float
        required: true
        description: "e.g., 99.9"
      - name: critical_fields
        type: list[str]
        required: false

  AccuracyRule:
    description: Check for data accuracy
    fields:
      - name: max_error_rate
        type: float
        required: true
        description: "e.g., 0.001 (0.1%)"
      - name: validation_method
        type: str
        required: false

  FreshnessRule:
    description: Check for data freshness
    fields:
      - name: max_age
        type: str
        required: true
        description: "ISO 8601 duration (e.g., PT24H)"
      - name: timestamp_field
        type: str
        required: true

  VolumeRule:
    description: Check for expected data volume
    fields:
      - name: min_rows
        type: int
        required: false
      - name: max_rows
        type: int
        required: false

  DistributionRule:
    description: Check for expected value distribution
    fields:
      - name: field
        type: str
        required: true
      - name: expected_distribution
        type: dict
        required: true
        description: Histogram, percentiles, etc.

  CustomCheck:
    description: User-defined quality check
    fields:
      - name: name
        type: str
        required: true
      - name: type
        type: CheckType
        required: true
      - name: definition
        type: str
        required: true
        description: The check logic (SQL/Python/GE)
      - name: severity
        type: CheckSeverity
        required: false
        default: error

  Quality:
    description: Data quality rules section
    fields:
      - name: completeness
        type: CompletenessRule
        required: false
      - name: accuracy
        type: AccuracyRule
        required: false
      - name: freshness
        type: FreshnessRule
        required: false
      - name: volume
        type: VolumeRule
        required: false
      - name: distribution
        type: DistributionRule
        required: false
      - name: custom_checks
        type: list[CustomCheck]
        required: false

  # ---------------------------------------------------------------------------
  # Legal Section
  # ---------------------------------------------------------------------------
  CrossBorder:
    description: Cross-border data transfer rules
    fields:
      - name: restrictions
        type: list[str]
        required: false
        description: Countries/regions where data cannot go
      - name: transfer_mechanisms
        type: list[str]
        required: false
        description: SCCs, BCRs, adequacy decisions
      - name: data_residency
        type: str
        required: false
        description: Where data must be stored

  Legal:
    description: Legal and regulatory information
    fields:
      - name: jurisdiction
        type: list[str]
        required: false
        description: Countries/regions governing this data
      - name: basis
        type: LegalBasis
        required: false
      - name: consent_id
        type: str
        required: false
        description: Reference to consent record
      - name: regulations
        type: list[str]
        required: false
        description: "GDPR, CCPA, HIPAA, etc."
      - name: cross_border
        type: CrossBorder
        required: false

  # ---------------------------------------------------------------------------
  # Compliance Section
  # ---------------------------------------------------------------------------
  AuditRequirements:
    description: Audit logging requirements
    fields:
      - name: logging
        type: bool
        required: false
        default: true
      - name: log_retention
        type: str
        required: false
        description: "ISO 8601 duration (e.g., P365D)"
        default: "P365D"

  ExportRestrictions:
    description: Data export restrictions
    fields:
      - name: allow_download
        type: bool
        required: false
        default: false
      - name: allow_external_transfer
        type: bool
        required: false
        default: false
      - name: allowed_destinations
        type: list[str]
        required: false

  Compliance:
    description: Compliance requirements
    fields:
      - name: data_classification
        type: SensitivityLevel
        required: false
        default: internal
      - name: regulatory_scope
        type: list[str]
        required: false
        description: "GDPR, CCPA, HIPAA, PCI-DSS, SOX, etc."
      - name: audit_requirements
        type: AuditRequirements
        required: false
      - name: certification_requirements
        type: list[str]
        required: false
        description: "SOC2, ISO27001, etc."
      - name: export_restrictions
        type: ExportRestrictions
        required: false

  # ---------------------------------------------------------------------------
  # Lineage Section (extends existing)
  # ---------------------------------------------------------------------------
  Extraction:
    description: Data extraction configuration
    fields:
      - name: method
        type: ExtractionMethod
        required: false
        default: full
      - name: filter
        type: str
        required: false
        description: Any filtering applied

  LineageSource:
    description: Data source for lineage
    fields:
      - name: type
        type: SourceType
        required: true
      - name: identifier
        type: str
        required: true
        description: System name, contract ID, path, URL, topic
      - name: description
        type: str
        required: false
      - name: fields_used
        type: list[str]
        required: false
      - name: extraction
        type: Extraction
        required: false

  Lineage:
    description: Data lineage/provenance section
    fields:
      - name: sources
        type: list[LineageSource]
        required: false

  # ---------------------------------------------------------------------------
  # SLA Section
  # ---------------------------------------------------------------------------
  AvailabilitySLA:
    description: Availability SLA
    fields:
      - name: target_percent
        type: float
        required: true
        description: "e.g., 99.9"
      - name: measurement_window
        type: str
        required: false
        description: "e.g., P30D (30 days)"

  FreshnessSLA:
    description: Freshness SLA
    fields:
      - name: target
        type: str
        required: true
        description: "e.g., PT4H (4 hours)"
      - name: measurement_field
        type: str
        required: false

  CompletenessSLA:
    description: Completeness SLA
    fields:
      - name: target_percent
        type: float
        required: true
      - name: critical_fields
        type: list[str]
        required: false
      - name: critical_target_percent
        type: float
        required: false

  AccuracySLA:
    description: Accuracy SLA
    fields:
      - name: error_rate_target
        type: float
        required: true
      - name: validation_method
        type: str
        required: false

  ResponseTimeSLA:
    description: API response time SLA
    fields:
      - name: p50_ms
        type: int
        required: false
      - name: p99_ms
        type: int
        required: false

  SLA:
    description: Service Level Agreements
    fields:
      - name: availability
        type: AvailabilitySLA
        required: false
      - name: freshness
        type: FreshnessSLA
        required: false
      - name: completeness
        type: CompletenessSLA
        required: false
      - name: accuracy
        type: AccuracySLA
        required: false
      - name: response_time
        type: ResponseTimeSLA
        required: false

  # ---------------------------------------------------------------------------
  # Access Section
  # ---------------------------------------------------------------------------
  AccessGrant:
    description: Individual access grant
    fields:
      - name: principal
        type: str
        required: true
        description: "team://, role://, user://, service://"
      - name: level
        type: AccessLevel
        required: true
      - name: fields
        type: list[str]
        required: false
        description: Specific fields (default: all)
      - name: expiry
        type: str
        required: false
        description: ISO date when grant expires
      - name: conditions
        type: dict
        required: false

  AccessApproval:
    description: Access approval workflow
    fields:
      - name: required
        type: bool
        required: false
        default: false
      - name: approvers
        type: list[str]
        required: false
      - name: workflow
        type: str
        required: false
        description: Reference to approval workflow

  AccessAuthentication:
    description: Authentication configuration
    fields:
      - name: methods
        type: list[str]
        required: false
        description: "oauth2, api_key, mtls, etc."
      - name: provider
        type: str
        required: false
        description: Identity provider

  Access:
    description: Access control configuration
    fields:
      - name: default_level
        type: AccessLevel
        required: false
        default: internal
      - name: grants
        type: list[AccessGrant]
        required: false
      - name: approval
        type: AccessApproval
        required: false
      - name: authentication
        type: AccessAuthentication
        required: false

  # ---------------------------------------------------------------------------
  # Distribution Section
  # ---------------------------------------------------------------------------
  Partitioning:
    description: Data partitioning configuration
    fields:
      - name: fields
        type: list[str]
        required: false
      - name: strategy
        type: PartitioningStrategy
        required: false

  DistributionChannel:
    description: Single distribution channel
    fields:
      - name: type
        type: DistributionType
        required: true
      - name: identifier
        type: str
        required: true
        description: Project.dataset.table, s3://path, topic, etc.
      - name: format
        type: str
        required: false
        description: "parquet, json, avro, etc."
      - name: partitioning
        type: Partitioning
        required: false

  Distribution:
    description: Data distribution channels
    fields:
      - name: channels
        type: list[DistributionChannel]
        required: false

  # ---------------------------------------------------------------------------
  # Governance Section
  # ---------------------------------------------------------------------------
  Producer:
    description: Data producer information
    fields:
      - name: team
        type: str
        required: true
      - name: contact
        type: str
        required: false
      - name: responsibilities
        type: list[str]
        required: false

  ConsumerInfo:
    description: Data consumer information
    fields:
      - name: team
        type: str
        required: true
      - name: contact
        type: str
        required: false
      - name: use_case
        type: str
        required: false
      - name: approved_date
        type: str
        required: false
      - name: approved_by
        type: str
        required: false

  ApprovalStep:
    description: Single approval in the chain
    fields:
      - name: role
        type: str
        required: true
        description: "data_owner, privacy_officer, security, legal"
      - name: approver
        type: str
        required: false
      - name: approved_date
        type: str
        required: false
      - name: comments
        type: str
        required: false

  Review:
    description: Governance review schedule
    fields:
      - name: cadence
        type: ReviewCadence
        required: false
        default: quarterly
      - name: last_review
        type: str
        required: false
      - name: next_review
        type: str
        required: false
      - name: reviewers
        type: list[str]
        required: false

  ChangeManagement:
    description: Change management policies
    fields:
      - name: breaking_change_notice
        type: str
        required: false
        description: "e.g., P30D (30 days notice)"
        default: "P30D"
      - name: deprecation_notice
        type: str
        required: false
        description: "e.g., P90D (90 days notice)"
        default: "P90D"
      - name: communication_channels
        type: list[str]
        required: false
      - name: migration_support
        type: bool
        required: false
        default: false

  DisputeResolution:
    description: Dispute resolution process
    fields:
      - name: process
        type: str
        required: false
      - name: escalation_path
        type: list[str]
        required: false

  Documentation:
    description: Documentation links
    fields:
      - name: wiki
        type: str
        required: false
      - name: runbook
        type: str
        required: false
      - name: changelog
        type: str
        required: false

  Governance:
    description: Governance and ownership information
    fields:
      - name: producer
        type: Producer
        required: false
      - name: consumers
        type: list[ConsumerInfo]
        required: false
      - name: approval_chain
        type: list[ApprovalStep]
        required: false
      - name: review
        type: Review
        required: false
      - name: change_management
        type: ChangeManagement
        required: false
      - name: dispute_resolution
        type: DisputeResolution
        required: false
      - name: documentation
        type: Documentation
        required: false

  # ---------------------------------------------------------------------------
  # Team Section
  # ---------------------------------------------------------------------------
  Steward:
    description: Data steward contact
    fields:
      - name: name
        type: str
        required: true
      - name: email
        type: str
        required: true

  Team:
    description: Responsible team information
    fields:
      - name: name
        type: str
        required: true
      - name: department
        type: str
        required: false
      - name: steward
        type: Steward
        required: false

  # ---------------------------------------------------------------------------
  # Server Section
  # ---------------------------------------------------------------------------
  Server:
    description: Infrastructure/server definition
    fields:
      - name: server
        type: str
        required: true
        description: Unique server name
      - name: environment
        type: str
        required: true
        description: "development, staging, production"
      - name: type
        type: str
        required: true
        description: "bigquery, redshift, snowflake, s3, kafka"
      - name: project
        type: str
        required: true
        description: Cloud project or account
      - name: dataset
        type: str
        required: true
        description: Dataset, database, or bucket name

  # ---------------------------------------------------------------------------
  # Role Section
  # ---------------------------------------------------------------------------
  Role:
    description: Role-based access definition
    fields:
      - name: role
        type: str
        required: true
      - name: access
        type: AccessLevel
        required: true

  # ---------------------------------------------------------------------------
  # Timestamps Section
  # ---------------------------------------------------------------------------
  Timestamps:
    description: Audit timestamps
    fields:
      - name: created_at
        type: str
        required: true
        description: ISO 8601 datetime
      - name: updated_at
        type: str
        required: true
        description: ISO 8601 datetime
      - name: effective_from
        type: str
        required: false
        description: When contract becomes active
      - name: effective_until
        type: str
        required: false
        description: When contract expires

# =============================================================================
# COMPLETE DATA CONTRACT
# =============================================================================
DataContract:
  description: Complete Open Data Contract Standard contract
  sections:
    required:
      - api_version
      - kind
      - id
      - name
      - version
      - status
      - description
      - schema
      - timestamps
    optional:
      - quality
      - legal
      - compliance
      - lineage
      - sla
      - access
      - distribution
      - governance
      - team
      - servers
      - roles

# =============================================================================
# BREAKING CHANGE RULES
# =============================================================================
breaking_changes:
  description: |
    Rules for determining if a contract change is breaking.
    Breaking changes require explicit acknowledgment (--allow-breaking flag).

  rules:
    field_removal:
      severity: breaking
      description: Removing an existing field

    field_type_change:
      severity: breaking
      description: |
        Changing field type incompatibly.
        Compatible changes (non-breaking):
        - integer -> float (widening)
        - any -> specific type (narrowing is breaking)
        Incompatible (breaking):
        - string -> integer
        - float -> integer (lossy)
        - boolean -> string

    field_rename:
      severity: breaking
      description: Renaming a field (detected as remove + add)

    required_field_addition:
      severity: breaking
      description: |
        Adding a required (non-nullable) field without a default value.
        Non-breaking if field has a default or is nullable.

    enum_value_removal:
      severity: breaking
      description: Removing values from an enum constraint

    constraint_tightening:
      severity: breaking
      description: |
        Making constraints more restrictive:
        - Reducing max_length
        - Increasing min_length
        - Adding stricter pattern
        - Reducing enum values
        - Reducing numeric bounds (ge/le/gt/lt)

    nullable_to_required:
      severity: breaking
      description: Making a nullable field non-nullable

  non_breaking:
    - Adding optional fields
    - Adding enum values
    - Relaxing constraints (increasing max_length, etc.)
    - Adding/updating metadata (descriptions, semantic info)
    - Adding quality rules
    - Adding governance information
    - Updating SLAs
